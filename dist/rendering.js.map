{"version":3,"sources":["../src/rendering.js"],"names":[],"mappings":"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","file":"rendering.js","sourcesContent":["import _ from 'lodash';\nimport $ from 'jquery';\nimport moment from 'moment';\nimport kbn from 'app/core/utils/kbn';\nimport vis from './vis';\n\nexport default function link(scope, elem, attrs, ctrl) {\n  var data, panel, position;\n  elem = elem.find('.graph3d-panel');\n\n  ctrl.events.on('render', function() {\n    render();\n    ctrl.renderingCompleted();\n  });\n\n  function setElementHeight() {\n    try {\n      var height = ctrl.height || panel.height || ctrl.row.height;\n      if (_.isString(height)) {\n        height = parseInt(height.replace('px', ''), 10);\n      }\n\n      height -= 5; // padding\n      height -= panel.title ? 24 : 9; // subtract panel title bar\n\n      elem.css('height', height + 'px');\n\n      return true;\n    } catch(e) { // IE throws errors sometimes\n      return false;\n    }\n  }\n\n  function render() {\n    if (!ctrl.data) { return; }\n\n    data = ctrl.data;\n    panel = ctrl.panel;\n\n    if (setElementHeight()) {\n      addGraph3d();\n    }\n  }\n\n  function getKey(arr, val) {\n    return parseInt(_.keys(arr).find(function(key) {\n      return arr[key] == val;\n    }));\n  }\n\n  function onCameraPositionChange(event) {\n    ctrl.currentCameraPosition = {\n      horizontal: event.horizontal,\n      vertical: event.vertical,\n      distance: event.distance\n    };\n  }\n\n  function createColumnFormater(style) {\n    var defaultFormater = function(v) {\n      if (v === null || v === void 0 || v === undefined) {\n        return '';\n      }\n      if (_.isArray(v)) {\n        v = v.join(', ');\n      }\n      return v;\n    };\n\n    if (! style) {\n      return defaultFormater;\n    }\n\n    switch (style.type) {\n    case 'date':\n      return v => {\n        if (_.isArray(v)) { v = v[0]; }\n        var date = moment(v);\n        if (ctrl.dashboard.isTimezoneUtc()) {\n          date = date.utc();\n        }\n        return date.format(style.dateFormat || 'YYYY-MM-DD HH:mm:ss');\n      };\n      break;\n\n    case 'number':\n      var valueFormater = kbn.valueFormats[style.unit];\n\n      return v =>  {\n        if (v === null || v === void 0) {\n          return '-';\n        }\n\n        if (_.isString(v)) {\n          return v;\n        }\n\n        return valueFormater(v, style.decimals, null);\n      };\n      break;\n\n    default:\n      return defaultFormater;\n    }\n\n  }\n\n  function addGraph3d() {\n    if (data.length === 0) {\n      return;\n    }\n\n    var formater = {\n        x: createColumnFormater(panel.styles.x),\n        y: createColumnFormater(panel.styles.y),\n        z: createColumnFormater(panel.styles.z)\n    };\n\n    var labels = _.pluck(data, 'label');\n\n    var datapoints = [];\n    datapoints.push(_.map(data[0].datapoints, function(dp) {\n      return formater.x(dp[1]);\n    }));\n    datapoints = datapoints.concat(_.map(data, function(serie) {\n      return _.map(serie.datapoints, function(dp) {\n        return dp[0];\n      });\n    }));\n\n    var valueLabels = _.map(datapoints, function(dp, i) {\n      if (i < 2) {\n        return _.uniq(dp);\n      }\n    });\n\n    // dataset\n    var graphdata = new vis.DataSet();\n    for (var i = 0; i < datapoints[0].length; i += 1) {\n      graphdata.add({\n        x: getKey(valueLabels[0], datapoints[0][i]),\n        y: getKey(valueLabels[1], datapoints[1][i]),\n        z: datapoints[2][i],\n        style: datapoints[2][i]\n      });\n    }\n\n    // prepare div for canvas\n    var plotDiv = document.createElement('div');\n\n    // css\n    var width = elem.width();\n    var height = elem.height();\n    $(plotDiv).css({\n      width: width + 'px',\n      height: height + 'px',\n      margin: 'auto',\n      position: 'relative'\n    });\n\n    var axisLabels = {\n        x: panel.styles.x.label || 'time',\n        y: panel.styles.y.label || labels[0],\n        z: panel.styles.z.label || labels[1]\n    };\n    var units = {\n        x: kbn.valueFormats[panel.styles.x.unit] || panel.styles.x.unit || '',\n        y: kbn.valueFormats[panel.styles.y.unit] || panel.styles.y.unit || '',\n        z: kbn.valueFormats[panel.styles.z.unit] || panel.styles.z.unit || ''\n    };\n\n    var options = {\n      width: width + 'px',\n      height: height + 'px',\n      axisColor: '#888888',\n\n      style:           panel.graphType,\n      showGrid:        true,\n      showShadow:      false,\n      showPerspective: panel.showPerspective || false,\n      verticalRatio:   panel.verticalRatio || 0.5,\n      keepAspectRatio: panel.keepAspectRatio || false,\n\n      xLabel: axisLabels.x,\n      yLabel: axisLabels.y,\n      zLabel: axisLabels.z,\n\n      xMin: panel.styles.x.min || null,\n      yMin: panel.styles.y.min || null,\n      zMin: panel.styles.z.min || null,\n\n      xMax: panel.styles.x.max || null,\n      yMax: panel.styles.y.max || null,\n      zMax: panel.styles.z.max || null,\n\n      xStep: panel.styles.x.step || null,\n      yStep: panel.styles.y.step || null,\n      zStep: panel.styles.z.step || null,\n\n      xValueLabel: function(key) {\n        return formater.x(valueLabels[0][key]);\n      },\n      yValueLabel: function(key) {\n        return formater.y(valueLabels[1][key]);\n      },\n      zValueLabel: function(key) {\n        return formater.z(key);\n      },\n\n      tooltip: function (point) {\n         return axisLabels.x + ': ' + formater.x(valueLabels[0][point.x]) + '<br>' +\n                axisLabels.y + ': ' + formater.y(valueLabels[1][point.y]) + '<br>' +\n                axisLabels.z + ': ' + '<b>' + formater.z(point.z) + '</b>';\n      }\n    };\n\n    for (var key in options) {\n        if (options[key] === null) {\n           delete options[key];\n        }\n    }\n\n    // draw\n    var graph3d = new vis.Graph3d(plotDiv, graphdata, options);\n    graph3d.on('cameraPositionChange', onCameraPositionChange);\n    graph3d.setCameraPosition(panel.cameraPosition);\n\n    elem.html(plotDiv);\n    graph3d.redraw();\n  }\n}\n\n"]}